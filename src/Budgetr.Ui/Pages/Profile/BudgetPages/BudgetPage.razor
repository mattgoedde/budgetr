@page "/profile/budgets"

@inject ILogger<BudgetPage> logger
@inject IToastService toast
@inject IDialogService dialog
@inject BudgetrApiService api

<FluentToolbar Style="width: 100%">
    <FluentSelect Items="@budgets" OptionValue="@(b => b.BudgetId.ToString())" OptionText="@(b => b.BudgetName)" @bind-SelectedOption="@selectedBudget" />
    <FluentButton IconEnd="@(new Icons.Regular.Size16.Delete())" OnClick="@DeleteButtonAsync"/>
    <FluentButton IconEnd="@(new Icons.Regular.Size16.Add())" OnClick="@AddButtonAsync"/>
    <FluentSpacer />
    <FrequencySelect @bind-Value="@frequency" />
</FluentToolbar>

@if (selectedBudget is not null)
{
    <HiddenLink Href="@($"/profile/budgets/{selectedBudget.BudgetId}/income")">
        <FluentCard Width="fit-content" Height="fit-content">
            <FluentLabel Weight="@FontWeight.Bold" Typo="@Typography.Subject">Income</FluentLabel>
            <FluentGrid Spacing="0" Justify="@JustifyContent.SpaceBetween">
                <FluentGridItem xs="6">Gross</FluentGridItem>
                <FluentGridItem xs="6">@selectedBudget.GrossIncome.ToString("C")</FluentGridItem>
                <FluentGridItem xs="6">Pre-Tax Deductions</FluentGridItem>
                <FluentGridItem xs="6">@selectedBudget.PreTaxDeductions.ToString("C")</FluentGridItem>
                <FluentGridItem xs="6">Taxes</FluentGridItem>
                <FluentGridItem xs="6">@selectedBudget.TaxDeductions.ToString("C")</FluentGridItem>
                <FluentGridItem xs="6">After Tax Deductions</FluentGridItem>
                <FluentGridItem xs="6">@selectedBudget.PostTaxDeductions.ToString("C")</FluentGridItem>
                <FluentGridItem xs="6">Net</FluentGridItem>
                <FluentGridItem xs="6">@selectedBudget.NetIncome.ToString("C")</FluentGridItem>
            </FluentGrid>
        </FluentCard>
    </HiddenLink>
}
else
{
    <FluentLabel>No budget selected</FluentLabel>
}

@code {
    Frequency frequency = Frequency.Monthly;
    BudgetSummaryModel? selectedBudget;
    IEnumerable<BudgetSummaryModel> budgets = Enumerable.Empty<BudgetSummaryModel>();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        await RefreshDataAsync();
    }

    async Task AddButtonAsync()
    {
        await AddBudgetAsync();
    }

    async Task DeleteButtonAsync()
    {
        await DeleteBudgetAsync();
    }

    async Task AddBudgetAsync()
    {
        try
        {
            var addDialog = await dialog.ShowPanelAsync<BudgetAddPanel>(new Budget(), new DialogParameters<Budget>
                {
                    Title = "Add Budget",
                    Content = new Budget(),
                    Alignment = HorizontalAlignment.Right
                });
            
            var result = await addDialog.Result;

            if (result.Cancelled) return;
            if (result.Data is null) return;

            var newBudget = result.Data as Budget;

            if(newBudget is null) return;

            await api.CreateBudget(newBudget);
        }
        catch (Exception ex)
        {
            toast.ShowError("Error creating new budget");
            logger.LogError(ex, "Error creating new budget");
        }
        finally
        {
            await RefreshDataAsync();
        }
    }

    async Task DeleteBudgetAsync()
    {
        try
        {
            if (selectedBudget is null) return;

            var deleteConfirmation = await dialog.ShowConfirmationAsync("Are you sure?", title: $"Delete {selectedBudget?.BudgetName}");

            var result = await deleteConfirmation.Result;

            if (result.Cancelled) return;

            await api.DeleteBudget(selectedBudget?.BudgetId ?? throw new Exception("Null budget"));
        }   
        catch (Exception ex)
        {
            toast.ShowError($"Error deleting {selectedBudget?.BudgetName ?? "budget"}");
            logger.LogError(ex, "Error deleting budget");
        } 
        finally
        {
            await RefreshDataAsync();
        }
    }

    async Task RefreshDataAsync()
    {
        try
        {
            budgets = await api.GetSummaries();

            if (selectedBudget is null) 
                selectedBudget = budgets.FirstOrDefault();
        }
        catch (Exception ex)
        {
            toast.ShowError($"Error retrieving your data");
            logger.LogError(ex, "Error retrieving budget summaries");
            budgets = Enumerable.Empty<BudgetSummaryModel>();
        }
        finally
        {
            StateHasChanged();
        }
    }
}
